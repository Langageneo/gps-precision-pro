<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dashboard Admin GPS</title>
<style>
body { font-family: Arial; margin: 20px; }
h1 { color: #333; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
th { background-color: #f5f5f5; }
button { padding: 6px 12px; margin: 5px; cursor: pointer; }
</style>
</head>
<body>
<h1>Dashboard Admin GPS</h1>

<div>
    <button onclick="fetchAnalytics()">Charger Analytics</button>
    <button onclick="exportCSV()">Exporter CSV</button>
</div>

<h2>Meilleur Livreur</h2>
<div id="bestLivreur"></div>

<h2>Produits Populaires</h2>
<table id="productsTable">
    <thead>
        <tr><th>Produit</th><th>Ventes</th></tr>
    </thead>
    <tbody></tbody>
</table>

<h2>Stats Livreur</h2>
<table id="analyticsTable">
    <thead>
        <tr>
            <th>ID Livreur</th>
            <th>Livraisons</th>
            <th>Distance (km)</th>
            <th>Score Moyen</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<h2>Alertes et Prévisions</h2>
<div id="alerts"></div>
<div id="predictive"></div>

<script>
const apiBase = '<?php echo esc_url(rest_url("gps/v2/analytics")); ?>';
const nonce = '<?php echo wp_create_nonce("wp_rest"); ?>';

async function fetchAnalytics() {
    try {
        const res = await fetch(apiBase, { headers: { 'X-WP-Nonce': nonce } });
        const data = await res.json();

        // Meilleur livreur
        document.getElementById("bestLivreur").innerText = JSON.stringify(data.meilleur_livreur || {}, null, 2);

        // Produits populaires
        const prodTbody = document.querySelector("#productsTable tbody");
        prodTbody.innerHTML = '';
        (data.produits_populaires || []).forEach(p => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${p[0]}</td><td>${p[1]}</td>`;
            prodTbody.appendChild(row);
        });

        // Stats livreur
        const tbody = document.querySelector("#analyticsTable tbody");
        tbody.innerHTML = '';
        (data.livreurs || []).forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.livreur_id}</td>
                <td>${item.livraisons}</td>
                <td>${item.distance_totale}</td>
                <td>${item.score_moyen}</td>
            `;
            tbody.appendChild(row);
        });

        // Alertes
        document.getElementById("alerts").innerText = "Alertes: " + JSON.stringify(data.alertes || [], null, 2);
        // Prédictions
        document.getElementById("predictive").innerText = "Prévisions: " + JSON.stringify(data.predictive || {}, null, 2);

    } catch (err) {
        console.error(err);
        alert('Erreur lors du chargement des analytics');
    }
}

function exportCSV() {
    const tables = [document.getElementById('analyticsTable'), document.getElementById('productsTable')];
    let csv = [];
    tables.forEach(table => {
        for (let row of table.rows) {
            let rowData = [];
            for (let cell of row.cells) rowData.push(cell.innerText);
            csv.push(rowData.join(','));
        }
        csv.push(""); // ligne vide entre tables
    });
    const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'analytics.csv';
    a.click();
}
</script>
</body>
</html>
